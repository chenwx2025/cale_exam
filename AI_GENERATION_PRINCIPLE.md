# AI 题目生成原理说明

## 概述

本系统的"AI 题目生成"功能并**不是使用真正的 AI/LLM（大语言模型）**，而是使用**基于模板的智能生成系统**。这是一个高度结构化的题目生成引擎，通过预定义的模板、变量和规则来生成符合 CALE/NCCAOM 考试标准的题目。

## 核心原理

### 1. 模板系统 (Template-Based Generation)

系统为每个考试领域（Domain）定义了详细的题目模板：

```typescript
{
  patterns: [  // 题干模板
    '患者{age}岁{gender}，主诉{chief_complaint}{duration}，伴{symptom2}。{tongue}，{pulse}。根据四诊合参，最可能的诊断是：'
  ],
  variables: {  // 可替换的变量
    age: ['25', '32', '38', '45', '52', '58', '65', '72'],
    gender: ['男', '女'],
    chief_complaint: ['头痛', '眩晕', '失眠', '心悸', ...],
    tongue: ['舌红少苔', '舌淡胖有齿痕苔白滑', ...],
    pulse: ['脉细数', '脉沉迟', '脉弦', ...]
  }
}
```

### 2. 题目生成流程

#### 步骤 1: 选择模板
根据用户选择的**考试类型**和**题目分类**，系统从预定义的模板库中选择对应的模板。

#### 步骤 2: 变量替换
- 从模板的 `patterns` 数组中随机选择一个题干模板
- 识别模板中的所有变量（用 `{变量名}` 标记）
- 从 `variables` 中随机选择对应的值进行替换

**示例：**
```
模板: "患者{age}岁{gender}，主诉{chief_complaint}"
替换后: "患者45岁男，主诉头痛"
```

#### 步骤 3: 生成选项和答案
根据题干内容和证候知识库，智能生成：
- **正确答案**：基于症状匹配证候
- **干扰项**：从相似证候中随机选择 3 个
- **选项顺序**：随机打乱

#### 步骤 4: 生成详细解析
根据证候特点、舌脉象、病机等信息，自动生成结构化的答案解析。

#### 步骤 5: 去重检查
- 检查生成的题目是否与数据库中现有题目重复
- 如果重复，重新生成（最多尝试 10 次）

### 3. 领域特定模板

系统为不同的 CALE 考试领域定义了专门的模板：

#### Domain 1: Patient Assessment (评估病人 - 27%)
- **模板特点**：基于四诊合参（望闻问切）
- **变量类型**：
  - 主诉症状：头痛、眩晕、失眠、心悸等
  - 伴随症状：气短乏力、口苦咽干等
  - 舌象：舌红少苔、舌淡胖有齿痕等
  - 脉象：脉细数、脉沉迟、脉弦等
- **知识库**：包含 50+ 种常见证候及其典型表现

#### Domain 2: Diagnosis (诊断 - 17%)
- **模板特点**：基于辨证方法
- **辨证体系**：
  - 八纲辨证（表里寒热虚实阴阳）
  - 六经辨证（太阳、阳明、少阳等）
  - 卫气营血辨证
  - 三焦辨证
  - 脏腑辨证

#### Domain 3A: Acupoint Selection (选穴 - 16%)
- **模板特点**：基于配穴原则
- **选穴方法**：
  - 近部选穴
  - 远部选穴
  - 对症选穴
  - 辨证选穴
- **穴位库**：包含常用穴位的功能、定位、主治

#### Domain 3B: Acupuncture Technique (针刺手法 - 8%)
- **模板特点**：针刺操作规范
- **内容**：
  - 进针方法
  - 行针手法（提插、捻转）
  - 得气感
  - 针刺深度和角度

#### Domain 3C: Adjunctive Techniques (辅助疗法 - 5%)
- **模板特点**：其他治疗方法
- **内容**：
  - 艾灸（直接灸、间接灸）
  - 拔罐（留罐、走罐、闪罐）
  - 刮痧
  - 电针

#### Domain 3D: Herbal Medicine (中药 - 15%)
- **模板特点**：方药知识
- **内容**：
  - 经典方剂（麻黄汤、桂枝汤、四君子汤等）
  - 中药性味归经
  - 配伍禁忌
  - 煎服方法

#### Domain 4: Professional Responsibilities (专业职责 - 11%)
- **模板特点**：加州法规和职业标准
- **内容**：
  - 执业范围
  - 病历管理（保存 7 年）
  - 清洁针法（CNT）
  - HIPAA 隐私保护
  - 继续教育（CEU）要求

## 核心代码结构

### 主要函数

```typescript
// 1. 主入口函数
export default defineEventHandler(async (event) => {
  // 接收参数：categoryId, count, difficulty
  // 生成指定数量的题目
  // 保存到数据库
})

// 2. 题目生成核心函数
function generateQuestion(
  categoryCode: string,    // 分类代码
  difficulty: string,       // 难度等级
  existingQuestions: Set<string>  // 已有题目（用于去重）
) {
  // 选择模板
  // 变量替换
  // 生成题目文本
  // 去重检查
  // 返回题目对象
}

// 3. 选项和答案生成函数
function generateOptionsAndAnswer(
  categoryCode: string,
  question: string,
  usedValues: any,
  template: any
) {
  // 根据领域类型生成正确答案
  // 生成干扰项
  // 随机打乱选项顺序
  // 生成详细解析
}
```

## 数据结构

### 题目模板结构
```typescript
{
  patterns: string[]           // 题干模板数组
  variables: {                 // 变量定义
    [key: string]: string[]    // 变量名 -> 可选值数组
  }
  syndromes?: Array<{          // 证候知识库（Domain 1）
    name: string               // 证候名称
    symptoms: string[]         // 典型症状
    tongue: string             // 舌象
    pulse: string              // 脉象
  }>
  acupoints?: {                // 穴位知识库（Domain 3A）
    [condition: string]: string[]  // 病症 -> 穴位数组
  }
  formulas?: {                 // 方剂知识库（Domain 3D）
    [name: string]: {
      composition: string      // 组成
      function: string         // 功效
    }
  }
}
```

### 生成的题目对象
```typescript
{
  question: string,          // 题目文本
  options: string,           // JSON 格式的选项数组
  correctAnswer: string,     // 正确答案（如 "A. 肝气郁结"）
  explanation: string,       // 详细解析
  difficulty: string,        // 难度（easy/medium/hard）
  type: 'multiple_choice',   // 题型
  examType: string,          // 考试类型（cale/nccaom）
  categoryId: string,        // 分类 ID
  source: 'AI Generated'     // 来源标记
}
```

## 优点和限制

### ✅ 优点

1. **高质量保证**
   - 基于真实考试大纲和官方资料
   - 所有知识点经过验证
   - 符合 CALE/NCCAOM 考试标准

2. **可控性强**
   - 完全可预测的输出
   - 不会生成错误或不合理的内容
   - 易于维护和更新

3. **性能优异**
   - 生成速度极快（毫秒级）
   - 无需调用外部 API
   - 不产生额外费用

4. **去重机制**
   - 自动检测重复题目
   - 保证题库多样性

5. **结构化解析**
   - 每道题都有详细的答案解析
   - 包含知识点、病机分析、证候特点

### ⚠️ 限制

1. **不是真正的 AI**
   - 基于预定义模板，不能自主学习
   - 不能理解自然语言问题
   - 无法生成模板之外的题目

2. **需要手动维护**
   - 新增题型需要编写模板代码
   - 知识库更新需要人工添加

3. **变化有限**
   - 题目变化受限于模板和变量定义
   - 可能出现相似题目

4. **领域依赖**
   - 只能生成已定义领域的题目
   - 未定义的分类无法生成

## 如何扩展

### 添加新的题目模板

1. 在 `questionTemplates` 对象中添加新的领域：

```typescript
questionTemplates['NEW_DOMAIN'] = [
  {
    patterns: [
      '新的题干模板 {variable1} {variable2}'
    ],
    variables: {
      variable1: ['值1', '值2', '值3'],
      variable2: ['值A', '值B', '值C']
    },
    // 添加知识库...
  }
]
```

2. 在 `generateOptionsAndAnswer` 函数中添加新领域的选项生成逻辑

### 优化现有模板

1. 增加更多变量值，提高题目多样性
2. 添加更多题干模板，增加题目变化
3. 扩展知识库，覆盖更多证候/穴位/方剂

## 与真正的 AI 对比

| 特性 | 当前系统（模板生成） | 真正的 AI（如 ChatGPT） |
|------|---------------------|------------------------|
| 生成原理 | 模板 + 变量替换 | 深度学习语言模型 |
| 内容质量 | 高（基于验证的知识） | 不确定（可能有错误） |
| 可控性 | 完全可控 | 难以控制 |
| 生成速度 | 极快（毫秒） | 较慢（秒级） |
| 成本 | 零成本 | 需要 API 费用 |
| 多样性 | 有限（受模板限制） | 非常高 |
| 可维护性 | 易于维护 | 难以调试 |
| 离线运行 | 完全离线 | 需要网络 |

## 总结

本系统采用的是**智能模板生成系统**而非真正的 AI，这种设计选择基于以下考虑：

1. **质量优先**：医学考试题目需要 100% 准确，模板系统可以保证这一点
2. **成本控制**：避免 AI API 调用费用
3. **速度性能**：毫秒级生成，用户体验好
4. **可靠稳定**：不依赖外部服务，完全可控

虽然名为"AI 生成"，但实际上是一个高度优化的**知识驱动的题目生成引擎**，专门为 CALE/NCCAOM 考试设计。

## 未来改进方向

如果需要引入真正的 AI，可以考虑：

1. **混合模式**：使用模板保证基础质量，用 AI 增加多样性
2. **AI 辅助**：用 AI 生成解析或干扰项
3. **质量审核**：人工审核 AI 生成的题目
4. **成本控制**：设置 API 调用限制和缓存机制
