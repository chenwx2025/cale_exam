# 发布前检查清单 (Pre-Publish Checklist)

## 📅 检查日期
2025-10-24

## ✅ 已完成检查

### 1. 项目构建状态
- ✅ **npm run build** - 客户端构建成功
  - 548 个模块转换完成
  - 所有资源正确生成（CSS + JS）
  - Gzip 压缩正常
  - ⚠️ **警告**: Duplicated imports "getRequestIP" (可忽略，不影响功能)

### 2. 核心功能验证
- ✅ **学习小组打卡功能** - 完全修复并验证
  - POST API 正常工作
  - GET API 正常工作
  - 数据库记录正确创建
  - 页面显示正常更新
  - 统计数据、日历、排行榜全部正常

- ✅ **BBS 论坛功能** - 第二阶段完成
  - 帖子发布、回复、编辑、删除
  - 点赞功能
  - Markdown 编辑器
  - @ 提及功能
  - 表情符号
  - 投票功能
  - 最佳答案标记
  - 书签功能
  - 置顶/精华/锁定帖子

- ✅ **学习笔记功能**
  - 个人笔记
  - 小组共享笔记
  - Markdown 支持

- ✅ **学习资源库** (已设计，待实现)

### 3. Git 状态
- 📝 **修改的文件**:
  - components/StudyGroupCheckIn.vue
  - pages/study-groups/[id]/index.vue
  - prisma/schema.prisma
  - 等多个文件

- 📝 **新增的文件**:
  - server/api/study-group-check-in.post.ts (扁平路由)
  - server/api/study-group-check-in.get.ts (扁平路由)
  - 多个 BBS 相关组件和 API
  - 完整的文档文件

### 4. 环境配置
- ✅ `.env.example` 存在并完整
- ✅ `.env.production.example` 存在
- ✅ `.env.aws.example` 存在
- ✅ `.gitignore` 正确配置

## ⚠️ 需要注意的问题

### 1. 连续学习天数 Unique Constraint 错误
**错误信息**: `Unique constraint failed on the fields: (userId,examType)`

**位置**: 学习提醒功能

**影响**: 运行时错误，可能影响学习统计功能

**建议**: 修复此错误后再发布
```javascript
// 需要检查的文件: server/plugins/scheduler.ts 或相关的学习统计 API
// 建议使用 upsert 而不是 create
```

### 2. 多个开发服务器实例在运行
**问题**: 发现有多个 `npm run dev` 进程在后台运行

**建议**: 发布前清理所有后台进程

### 3. 调试日志过多
**位置**: 多个组件和 API 文件中有大量 `console.log` 调试输出

**建议**: 清理或注释掉生产环境不需要的日志

## ❌ 待完成任务

### 必须完成（阻塞发布）

1. **修复连续学习天数错误**
   - [ ] 定位具体代码位置
   - [ ] 修改为使用 `upsert` 或添加错误处理
   - [ ] 测试修复效果

2. **清理后台进程**
   - [ ] 停止所有开发服务器：`pkill -9 node`
   - [ ] 清理临时文件：`rm -rf .nuxt .output`

3. **运行完整的生产构建测试**
   - [ ] `npm run build`
   - [ ] 确保无错误
   - [ ] `npm run preview` 测试生产构建

4. **数据库迁移准备**
   - [ ] 确认 Prisma schema 没有未应用的更改
   - [ ] 生成迁移文件：`npx prisma migrate dev`
   - [ ] 测试迁移在新数据库上的应用

### 推荐完成（不阻塞发布，但强烈建议）

5. **清理调试代码**
   - [ ] 搜索并移除/注释生产环境不需要的 `console.log`
   - [ ] 移除测试用的 API 端点（如 `/api/test-checkin`）
   - [ ] 移除调试用的页面（如 `/pages/token-update.vue`）

6. **整理文档文件**
   - [ ] 移动所有 .md 文档文件到 `/docs` 目录
   - [ ] 或者在 `.gitignore` 中添加不需要提交的文档

7. **环境变量检查**
   - [ ] 确认生产环境的 JWT_SECRET 已更改
   - [ ] 确认生产环境的数据库 URL 正确
   - [ ] 确认 VAPID keys 已生成
   - [ ] 确认 SMTP 配置完整

8. **Git 提交**
   - [ ] 审查所有修改
   - [ ] 创建有意义的 commit message
   - [ ] 确认不提交敏感信息（.env 文件）

## 🧪 测试清单

### 功能测试

- [ ] 用户注册/登录
- [ ] 考试类型选择
- [ ] 学习计划功能
- [ ] 知识点查看
- [ ] 学习小组
  - [ ] 创建小组
  - [ ] 加入/退出小组
  - [ ] 打卡功能
  - [ ] 讨论区（BBS）
  - [ ] 笔记功能
- [ ] 个人资料
- [ ] 通知系统

### 性能测试

- [ ] 首页加载时间 < 3秒
- [ ] API 响应时间 < 500ms
- [ ] 图片加载优化
- [ ] 代码分割正常工作

### 浏览器兼容性

- [ ] Chrome (最新版本)
- [ ] Firefox (最新版本)
- [ ] Safari (最新版本)
- [ ] Edge (最新版本)
- [ ] 移动浏览器

## 📋 生产部署准备

### 服务器配置

- [ ] Node.js 版本 >= 18
- [ ] PM2 或其他进程管理器
- [ ] Nginx 反向代理配置
- [ ] SSL 证书配置
- [ ] 防火墙规则

### 数据库

- [ ] 生产数据库创建
- [ ] 运行 Prisma 迁移
- [ ] 创建数据库备份策略
- [ ] 配置数据库连接池

### 监控和日志

- [ ] 配置应用日志
- [ ] 配置错误追踪（如 Sentry）
- [ ] 配置性能监控
- [ ] 配置服务器监控

### 备份策略

- [ ] 数据库定期备份
- [ ] 代码仓库备份
- [ ] 环境配置备份
- [ ] 静态资源备份

## 🚀 发布流程

### 1. 准备阶段
```bash
# 1. 清理环境
pkill -9 node
rm -rf .nuxt .output node_modules/.cache

# 2. 重新安装依赖
npm ci

# 3. 运行 Prisma 生成
npx prisma generate

# 4. 应用数据库迁移
npx prisma migrate deploy
```

### 2. 构建阶段
```bash
# 1. 运行生产构建
npm run build

# 2. 测试生产构建
npm run preview

# 3. 验证所有页面可访问
```

### 3. 发布阶段
```bash
# 1. 提交代码
git add .
git commit -m "准备生产发布 - 打卡功能修复 + BBS功能完善"
git push origin main

# 2. 创建发布标签
git tag -a v1.0.0 -m "首次生产发布"
git push origin v1.0.0

# 3. 部署到服务器
# (根据你的部署方式: AWS, Vercel, 自托管等)
```

### 4. 发布后验证
- [ ] 所有页面可访问
- [ ] 关键功能正常工作
- [ ] 检查服务器日志无错误
- [ ] 监控系统指标正常
- [ ] 创建数据库备份

## 📊 关键指标

| 指标 | 当前值 | 目标值 | 状态 |
|------|--------|--------|------|
| 构建时间 | ~90s | <120s | ✅ |
| 客户端包大小 | ~84KB (gzipped) | <100KB | ✅ |
| 首屏加载时间 | 待测试 | <3s | ⏳ |
| API 响应时间 | 待测试 | <500ms | ⏳ |
| 测试覆盖率 | 0% | >60% | ❌ |

## 🔍 已知问题

### 高优先级
1. ⚠️ 连续学习天数 unique constraint 错误

### 中优先级
1. ⚠️ 调试日志过多，需要清理
2. ⚠️ 测试 API 端点未移除
3. ⚠️ 文档文件混在项目根目录

### 低优先级
1. ℹ️ Duplicated imports 警告
2. ℹ️ 缺少自动化测试
3. ℹ️ 缺少 API 文档

## 📝 发布说明模板

```markdown
# v1.0.0 - 首次生产发布

## 🎉 主要功能

### 学习小组
- ✅ 创建和加入学习小组
- ✅ 一键打卡系统（修复了嵌套路由问题）
- ✅ 打卡统计和排行榜
- ✅ 本周打卡日历

### BBS 论坛系统（第二阶段）
- ✅ 帖子CRUD操作
- ✅ Markdown 编辑器
- ✅ @ 提及功能
- ✅ 表情符号选择器
- ✅ 投票功能
- ✅ 最佳答案标记
- ✅ 书签系统
- ✅ 帖子管理（置顶/精华/锁定）

### 学习笔记
- ✅ 个人笔记
- ✅ 小组共享笔记
- ✅ Markdown 支持

## 🐛 Bug 修复
- 修复了学习小组打卡功能的嵌套动态路由问题
- 修复了 toLocaleTimeString 兼容性问题
- 修复了 Prisma 查询字段错误
- 修复了小组详情页 user 未定义错误

## ⚙️ 技术改进
- 使用扁平路由替代嵌套动态路由
- 优化时间格式化方法
- 改进错误处理和日志记录

## 📚 文档
- 完整的打卡功能修复文档
- BBS 功能实现文档
- API 路由设计文档

## ⚠️ 已知限制
- 学习资源库功能尚未实现
- 缺少自动化测试
- 部分调试日志待清理
```

## ✅ 最终检查

### 发布前最后确认

- [ ] 所有高优先级问题已解决
- [ ] 生产构建成功且无错误
- [ ] 环境变量已正确配置
- [ ] 数据库迁移已测试
- [ ] 关键功能已手动测试
- [ ] Git 仓库状态干净
- [ ] 备份策略已就位
- [ ] 回滚计划已准备
- [ ] 团队成员已通知
- [ ] 发布时间已确定

---

**创建日期**: 2025-10-24
**最后更新**: 2025-10-24
**负责人**: 开发团队
**预计发布日期**: 待定
