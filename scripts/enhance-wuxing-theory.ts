import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function enhanceWuXingTheory() {
  try {
    // 查找Domain 1分类
    const category = await prisma.category.findFirst({
      where: { code: 'DOMAIN_1_ASSESSMENT' }
    })

    if (!category) {
      console.log('❌ 未找到Domain 1分类')
      return
    }

    // 解析现有知识点
    let keyPoints = []
    if (category.keyPoints) {
      try {
        keyPoints = JSON.parse(category.keyPoints)
      } catch (e) {
        console.log('❌ 解析现有知识点失败')
        return
      }
    }

    // 查找五行学说知识点
    const wuxingIndex = keyPoints.findIndex((p: any) => p.title === '五行学说')

    if (wuxingIndex === -1) {
      console.log('❌ 未找到五行学说知识点')
      return
    }

    // 增强的五行学说内容
    const enhancedContent = {
      detailedExplanation: `
一、五行基本概念
五行学说认为木、火、土、金、水是构成宇宙万物的五种基本元素。

二、五行生克关系

【相生关系】
• 木生火：肝血济心火
• 火生土：心阳温脾土
• 土生金：脾化气血养肺
• 金生水：肺气助肾水
• 水生木：肾精滋养肝木

【相克关系】
• 木克土：肝疏泄调脾土
• 土克水：脾运化制肾水
• 水克火：肾阴制心火
• 火克金：心火制肺金
• 金克木：肺气制肝木

三、五行辨证（病理关系）

【母病及子】
• 木不生火：肝血不足，心血虚（母虚子弱）
• 火不生土：心阳不振，脾阳虚（母虚及子）
• 土不生金：脾气虚，肺气虚（母病及子）
• 金不生水：肺气虚，肾阳虚（母虚及子）
• 水不涵木：肾阴虚，肝阴虚（水不涵木）

【子病犯母】
• 火不足→反过来耗伤肝木：心血虚反过来耗肝血
• 土不足→反过来耗伤心火：脾阳虚损及心阳
• 金不足→反过来耗伤脾土：肺气虚损及脾气
• 水不足→反过来耗伤肺金：肾精不足，肺失滋养
• 木不足→反过来耗伤肾水：肝血虚损及肾精

【相克太过】（相克关系失常）
• 木克土太过：肝气横逆犯脾（肝郁脾虚）
• 土克水太过：脾湿困肾（脾实肾虚）
• 水克火太过：肾寒侮心（肾寒心衰）
• 火克金太过：心火烁肺（心火亢肺阴虚）
• 金克木太过：肺燥伤肝（肺燥肝血虚）

【相侮】（反克、欺侮）
• 木侮金：肝火犯肺（木火刑金）
• 金侮火：肺金清肃太过，心火受制
• 火侮水：心火亢盛，肾阴被伤
• 水侮土：肾水泛滥，脾阳受困
• 土侮木：脾湿困厄，肝失疏泄

四、治则治法

【基本原则】
• 实则泻其子：如肝火旺（木盛）→泻心火（泻其子）
• 虚则补其母：如心血虚（火虚）→补肝血（补其母）

【具体治法】
• 抑木扶土：肝郁脾虚证（疏肝健脾）
• 培土制水：脾虚水泛证（健脾利水）
• 佐金平木：肝阳上亢证（清肺平肝）
• 泻南补北：心肾不交证（清心火、滋肾水）
• 滋水涵木：肝肾阴虚证（滋补肝肾）

五、五脏病传规律

【传变方式】
• 母病及子：肝病→心病（木病及火）
• 子病犯母：心病→肝病（火病及木）
• 相克传变：肝病→脾病（木克土）
• 相侮传变：肝病→肺病（木侮金）

【预后判断】
• 顺传：相生方向传变，预后较好
• 逆传：相克方向传变，预后较差
`,

      clinicalCases: [
        '案例1：母病及子（木不生火）\n【症状】肝血不足导致心血虚，表现为头晕目眩、心悸失眠、面色无华\n【病机】肝藏血不足，不能上济心火，心失所养\n【治则】补肝养血，兼养心血（补母即所以补子）',

        '案例2：子病犯母（火不足耗肝木）\n【症状】心血亏虚，反过来耗损肝血，心悸、失眠、眩晕加重\n【病机】心血虚不能下归肝，肝血更虚\n【治则】养心补血为主，兼养肝血',

        '案例3：相克太过（木克土）\n【症状】肝气横逆犯脾，胸胁胀痛、腹胀便溏、情绪抑郁\n【病机】肝失疏泄，横逆犯脾，脾失健运\n【治则】疏肝健脾（抑木扶土）\n【方药】逍遥散（柴胡疏肝，白术健脾）',

        '案例4：相侮（木火刑金）\n【症状】肝火旺盛，上逆犯肺，咳嗽、胸痛、烦躁易怒\n【病机】肝火亢盛，反侮肺金，肺失清肃\n【治则】清肝泻火，保肺清金（佐金平木）\n【方药】黛蛤散（青黛清肝，蛤壳清肺）',

        '案例5：虚则补其母\n【症状】心血虚证，心悸、失眠、健忘、面色无华\n【病机】心血不足，心失所养\n【治则】补肝血以生心血（虚则补其母）\n【方药】四物汤补肝血为主，配合酸枣仁、远志养心安神',

        '案例6：实则泻其子\n【症状】肝火亢盛，头痛目赤、烦躁易怒、口苦\n【病机】肝火过旺，木火上炎\n【治则】泻心火以平肝木（实则泻其子）\n【方药】龙胆泻肝汤（龙胆草、栀子清泻肝火）',

        '案例7：培土制水\n【症状】脾虚水肿，腹胀、便溏、小便不利、下肢浮肿\n【病机】脾阳虚衰，不能运化水湿，水湿泛滥\n【治则】健脾利水（培土制水）\n【方药】实脾饮（白术、茯苓健脾利水）',

        '案例8：滋水涵木\n【症状】肝肾阴虚，头晕目眩、腰膝酸软、五心烦热、口干\n【病机】肾阴不足，不能滋养肝木，肝阴亦虚\n【治则】滋补肾阴以涵养肝木\n【方药】六味地黄丸（熟地、山萸肉滋肾阴，配合当归、白芍养肝血）'
      ],

      keyFormulas: [
        '母病及子公式：木虚→火虚；火虚→土虚；土虚→金虚；金虚→水虚；水虚→木虚',
        '子病犯母公式：火虚耗木；土虚耗火；金虚耗土；水虚耗金；木虚耗水',
        '相克太过公式：木盛克土（肝旺脾虚）；土盛克水（脾实肾虚）；水盛克火（肾寒心衰）',
        '相侮公式：木侮金（肝火犯肺）；金侮火；火侮水；水侮土；土侮木',
        '虚则补其母：心虚补肝、脾虚补心、肺虚补脾、肾虚补肺、肝虚补肾',
        '实则泻其子：肝实泻心、心实泻脾、脾实泻肺、肺实泻肾、肾实泻肝',
        '抑木扶土法：疏肝健脾（逍遥散）- 治肝郁脾虚',
        '培土制水法：健脾利水（实脾饮）- 治脾虚水肿',
        '佐金平木法：清肺平肝（白芍、桑叶）- 治肝阳上亢',
        '泻南补北法：清心滋肾（黄连、知母）- 治心肾不交',
        '滋水涵木法：滋肾养肝（六味地黄丸）- 治肝肾阴虚'
      ],

      commonMistakes: [
        '❌ 错误：认为五行只是相生相克的简单循环\n✅ 正确：五行包括生、克、乘、侮四种关系，病理上更复杂',

        '❌ 错误：母病及子就等于子病犯母\n✅ 正确：母病及子是母脏虚弱影响子脏（顺传）；子病犯母是子脏虚损反过来耗伤母脏（逆传）',

        '❌ 错误：肝火旺应该泻肝火\n✅ 正确：可以"实则泻其子"，泻心火来间接平肝火（龙胆泻肝汤就是这个原理）',

        '❌ 错误：心血虚就补心\n✅ 正确：可以"虚则补其母"，补肝血来生心血（四物汤补肝血为主）',

        '❌ 错误：木克土就是肝病一定传脾\n✅ 正确：这是病理传变的一种可能，不是必然；要看整体情况',

        '❌ 错误：相侮就是相克的反方向\n✅ 正确：相侮是被克者反过来欺侮克者，如肝火旺反侮肺金（木侮金），是病理状态',

        '❌ 错误：五行生克关系是绝对的\n✅ 正确：五行关系是相对的，要结合虚实、阴阳、气血等综合判断'
      ]
    }

    // 更新五行学说知识点
    keyPoints[wuxingIndex] = {
      ...keyPoints[wuxingIndex],
      ...enhancedContent
    }

    // 更新数据库
    await prisma.category.update({
      where: { id: category.id },
      data: {
        keyPoints: JSON.stringify(keyPoints)
      }
    })

    console.log('✅ 五行学说已成功增强，包含以下内容：')
    console.log('  - 详细的五行生克关系解释')
    console.log('  - 母病及子、子病犯母病理关系')
    console.log('  - 相克太过、相侮的病理表现')
    console.log('  - 完整的治则治法（抑木扶土、培土制水等）')
    console.log('  - 8个临床案例')
    console.log('  - 11个关键公式')
    console.log('  - 7个常见错误纠正')

  } catch (error) {
    console.error('更新失败:', error)
  } finally {
    await prisma.$disconnect()
  }
}

enhanceWuXingTheory()
