import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

interface EnhancedKeyPoint {
  title: string
  description: string
  examples: string[]
  detailedExplanation?: string
  clinicalCases?: string[]
  visualDiagram?: string
  keyFormulas?: string[]
  commonMistakes?: string[]
}

const enhancedKnowledgePoints = {
  // Domain 1: 評估病人
  'DOMAIN_1_ASSESSMENT': {
    keyPoints: [
      {
        title: '四诊合参',
        description: '四诊合参是中医诊断的核心方法，通过望、闻、问、切四种诊法全面收集患者信息，综合分析得出诊断结论。四诊所得必须相互印证、相互补充，才能准确辨证。',
        examples: [
          '望诊：观察面色苍白 → 提示气血不足',
          '闻诊：声音低微无力 → 印证气虚证候',
          '问诊：自诉疲倦乏力 → 进一步确认气虚',
          '切诊：脉象细弱 → 四诊合参确诊气虚证'
        ],
        detailedExplanation: `四诊的层次关系：
1. 望诊 - 获取外在表现（面色、舌象、形态）
2. 闻诊 - 收集声音气味信息（语声、呼吸、体味）
3. 问诊 - 了解主观症状和病史（症状、病程、既往史）
4. 切诊 - 触摸体表获取信息（脉象、按诊、触诊）

诊断流程：望 → 初步判断 → 闻问 → 收集证据 → 切 → 验证结论 → 合参 → 确定诊断`,
        visualDiagram: `
┌─────────────────────────────────────┐
│         四诊合参流程图              │
├─────────────────────────────────────┤
│                                     │
│  望诊 ──→ 面色舌苔形态             │
│    ↓                                │
│  闻诊 ──→ 声音气味                 │
│    ↓                                │
│  问诊 ──→ 症状病史                 │
│    ↓                                │
│  切诊 ──→ 脉象腹诊                 │
│    ↓                                │
│  综合分析 ──→ 辨证论治             │
│                                     │
└─────────────────────────────────────┘`,
        clinicalCases: [
          '案例1：患者面色萎黄（望），声音低微（闻），自诉气短乏力（问），脉细弱（切）→ 诊断：气血两虚',
          '案例2：患者面红目赤（望），口气臭秽（闻），口渴欲饮（问），脉洪数（切）→ 诊断：实热证'
        ],
        commonMistakes: [
          '❌ 仅凭单一诊法就下结论',
          '❌ 忽视四诊之间的矛盾',
          '❌ 不结合整体进行分析',
          '✅ 应综合四诊，相互印证'
        ]
      },
      {
        title: '舌诊要点',
        description: '舌诊是通过观察舌质和舌苔的变化来判断疾病性质的诊法。舌质反映脏腑气血盛衰，舌苔反映病邪性质和病位深浅。',
        examples: [
          '舌质淡白 → 气血不足，阳虚',
          '舌质红绛 → 热盛伤阴',
          '舌质紫暗 → 血瘀证',
          '舌苔白厚 → 寒湿内停',
          '舌苔黄腻 → 湿热内蕴'
        ],
        detailedExplanation: `舌诊要点：

一、舌质（舌体本身）
• 颜色：淡白（虚寒）、淡红（正常）、红（热）、绛（热盛）、紫（瘀）
• 形态：胖大（虚）、瘦薄（阴虚）、齿痕（脾虚湿盛）
• 运动：强硬（热盛）、痿软（气血虚）、歪斜（中风）

二、舌苔（舌面覆盖物）
• 颜色：白（寒）、黄（热）、灰黑（热极或寒极）
• 厚薄：薄（病浅）、厚（病深、邪气盛）
• 润燥：润（津液充足）、燥（津液亏损）
• 腐腻：腐（胃气败）、腻（湿浊）`,
        visualDiagram: `
┌─────────────────────────────────────┐
│          舌诊对照图                 │
├─────────────────────────────────────┤
│                                     │
│  舌质淡白 ────→ 气血虚、阳虚       │
│  舌质淡红 ────→ 正常               │
│  舌质红 ──────→ 热证               │
│  舌质绛 ──────→ 热盛伤阴           │
│  舌质紫 ──────→ 血瘀               │
│                                     │
│  舌苔白 ──────→ 寒证               │
│  舌苔黄 ──────→ 热证               │
│  舌苔厚 ──────→ 邪气盛、病较重     │
│  舌苔薄 ──────→ 邪气浅、病较轻     │
│                                     │
└─────────────────────────────────────┘`,
        clinicalCases: [
          '案例1：舌淡胖大有齿痕，苔白滑 → 脾虚水湿内停 → 治法：健脾利湿',
          '案例2：舌红少苔 → 阴虚内热 → 治法：滋阴降火'
        ],
        commonMistakes: [
          '❌ 看舌后立即进食影响舌象',
          '❌ 只看舌苔不看舌质',
          '❌ 光线不足时观察',
          '✅ 应在自然光下，空腹时观察'
        ]
      },
      {
        title: '脉诊要点',
        description: '脉诊是通过触摸桡动脉来判断脏腑气血状况的诊法。寸关尺三部分候不同脏腑，浮沉迟数是脉诊的基本要素。',
        examples: [
          '浮脉 → 病位在表，外感初期',
          '沉脉 → 病位在里，内脏疾病',
          '迟脉 → 寒证，代谢减慢',
          '数脉 → 热证，代谢亢进',
          '细脉 → 气血虚弱'
        ],
        detailedExplanation: `脉诊系统：

一、诊脉部位（寸关尺三部）
左手：
• 寸 - 心、小肠
• 关 - 肝、胆
• 尺 - 肾、膀胱

右手：
• 寸 - 肺、大肠
• 关 - 脾、胃
• 尺 - 肾（命门）、三焦

二、常见脉象（28脉）
基本脉象：浮、沉、迟、数
虚实脉象：虚、实、洪、细、微
长短脉象：长、短
滑涩脉象：滑、涩
等...

三、诊脉方法
1. 布指：食指在寸，中指在关，无名指在尺
2. 举按寻：轻取（举）、重取（按）、寻找（寻）
3. 时间：每次诊脉至少1分钟`,
        visualDiagram: `
┌─────────────────────────────────────┐
│        寸关尺定位图                 │
├─────────────────────────────────────┤
│                                     │
│  左手：               右手：        │
│  寸 → 心小肠         寸 → 肺大肠   │
│  关 → 肝胆           关 → 脾胃     │
│  尺 → 肾膀胱         尺 → 肾命门   │
│                                     │
│  ┌───┐                              │
│  │浮 │ ──→ 轻取即得（表证）        │
│  ├───┤                              │
│  │中 │ ──→ 不轻不重（半表半里）    │
│  ├───┤                              │
│  │沉 │ ──→ 重按始得（里证）        │
│  └───┘                              │
│                                     │
└─────────────────────────────────────┘`,
        clinicalCases: [
          '案例1：脉浮数有力 + 发热恶寒 → 外感风热 → 辛凉解表',
          '案例2：脉沉细无力 + 面色苍白 → 气血两虚 → 补益气血'
        ],
        commonMistakes: [
          '❌ 诊脉时间过短（少于30秒）',
          '❌ 用力不当（过轻或过重）',
          '❌ 不分左右手',
          '✅ 应安静状态下，诊脉1分钟以上'
        ]
      },
      {
        title: '辨证论治',
        description: '辨证论治是中医理论的核心，通过辨证确定疾病的证型，再根据证型确定治疗原则和方药。"证"是疾病某一阶段的病理概括。',
        examples: [
          '同病异治：感冒 → 风寒感冒用辛温解表，风热感冒用辛凉解表',
          '异病同治：咳嗽、泄泻都有脾虚证 → 都用健脾益气法',
          '虚证 → 补法（补气、补血、补阴、补阳）',
          '实证 → 泻法（汗、吐、下、和、温、清、消、补）'
        ],
        detailedExplanation: `辨证论治体系：

一、辨证方法
1. 八纲辨证（表里、寒热、虚实、阴阳）- 基础
2. 脏腑辨证 - 定位
3. 六经辨证 - 伤寒病
4. 卫气营血辨证 - 温病
5. 三焦辨证 - 温病

二、治疗原则
• 治病求本 - 找到疾病根本原因
• 扶正祛邪 - 平衡正气与邪气
• 调整阴阳 - 恢复阴阳平衡
• 因人因时因地制宜 - 个体化治疗

三、八法
汗法（发汗解表）、吐法（涌吐痰涎）
下法（泻下通便）、和法（和解少阳）
温法（温里散寒）、清法（清热泻火）
消法（消食导滞）、补法（补益虚损）`,
        visualDiagram: `
┌─────────────────────────────────────┐
│       辨证论治流程图                │
├─────────────────────────────────────┤
│                                     │
│  四诊收集信息                       │
│       ↓                             │
│  辨证（确定证型）                   │
│       ↓                             │
│  立法（确定治则）                   │
│       ↓                             │
│  选方（选择方剂）                   │
│       ↓                             │
│  用药（调整药物）                   │
│                                     │
│  示例：                             │
│  发热恶寒 + 脉浮                    │
│       ↓                             │
│  风寒表证                           │
│       ↓                             │
│  辛温解表                           │
│       ↓                             │
│  麻黄汤                             │
│                                     │
└─────────────────────────────────────┘`,
        clinicalCases: [
          '案例：患者咳嗽（病）→ 辨证：风寒咳嗽（证）→ 论治：疏风散寒，宣肺止咳（法）→ 三拗汤加减（方）',
          '案例：两个胃痛患者 → 一个寒证用温中散寒，一个热证用清热和胃 → 同病异治'
        ]
      }
    ]
  },

  // Domain 3A: 針刺選穴
  'DOMAIN_3A_ACU_SELECTION': {
    keyPoints: [
      {
        title: '循经取穴原则',
        description: '根据经络循行路线选取穴位。哪条经络循行部位有病，就选取该经络上的穴位治疗。这是针灸选穴的基本原则。',
        examples: [
          '头痛前额 → 选足阳明胃经穴位（头维、阳白）',
          '头痛侧面 → 选足少阳胆经穴位（风池、率谷）',
          '牙痛上齿 → 选手阳明大肠经穴位（合谷、颊车）',
          '胃痛 → 选足阳明胃经穴位（足三里、中脘）'
        ],
        detailedExplanation: `循经取穴的理论基础：

一、十二经脉循行
手三阴：从胸走手（肺、心包、心）
手三阳：从手走头（大肠、三焦、小肠）
足三阳：从头走足（胃、胆、膀胱）
足三阴：从足走腹（脾、肝、肾）

二、选穴规律
1. 头面部疾病 - 选手足三阳经穴
2. 胸腹部疾病 - 选手足三阴经穴
3. 腰背部疾病 - 选足太阳膀胱经穴
4. 经络循行部位病 - 选本经穴

三、经络对应关系
• 足太阳膀胱经 → 头、项、背、腰、腿后
• 足阳明胃经 → 面、胸、腹、腿前
• 足少阳胆经 → 头侧、胁肋、腿外侧`,
        visualDiagram: `
┌─────────────────────────────────────┐
│      经络循行与选穴对应图           │
├─────────────────────────────────────┤
│                                     │
│  头部：                             │
│  ┌─────────────┐                    │
│  │ 前额 → 胃经 │                    │
│  │ 侧面 → 胆经 │                    │
│  │ 后项 → 膀胱经│                    │
│  └─────────────┘                    │
│                                     │
│  躯干：                             │
│  胸部 → 肺经、心包经                │
│  腹部 → 脾经、肝经、肾经            │
│  背部 → 膀胱经                      │
│                                     │
│  四肢：                             │
│  臂内侧 → 手三阴                    │
│  臂外侧 → 手三阳                    │
│  腿内侧 → 足三阴                    │
│  腿外侧 → 足三阳                    │
│                                     │
└─────────────────────────────────────┘`,
        clinicalCases: [
          '案例1：患者偏头痛（太阳穴区域）→ 循经取穴：选足少阳胆经的风池、阳陵泉、丘墟 → 效果显著',
          '案例2：患者腰背痛 → 循经取穴：选足太阳膀胱经的委中、昆仑、腰阳关 → 疼痛缓解'
        ],
        commonMistakes: [
          '❌ 不了解经络循行就随意选穴',
          '❌ 混淆不同经络的循行范围',
          '✅ 熟记十二经脉循行路线',
          '✅ 记住"头面手足三阳经，胸腹手足三阴经"'
        ]
      },
      {
        title: '辨证配穴方法',
        description: '根据中医辨证结果选择相应的穴位配伍。不同的证型需要不同的穴位组合，体现"治病求本"的原则。',
        examples: [
          '气虚证 → 气海、关元、足三里（补气）',
          '血虚证 → 血海、膈俞、三阴交（养血）',
          '阳虚证 → 命门、肾俞、关元（温阳）',
          '阴虚证 → 太溪、三阴交、照海（滋阴）',
          '气滞证 → 太冲、期门、内关（理气）'
        ],
        detailedExplanation: `辨证配穴系统：

一、虚证配穴
• 气虚 → 补气穴：足三里、气海、关元、脾俞
• 血虚 → 养血穴：血海、膈俞、三阴交、肝俞
• 阴虚 → 滋阴穴：太溪、三阴交、照海、肾俞
• 阳虚 → 温阳穴：命门、关元、肾俞、神阙

二、实证配穴
• 气滞 → 理气穴：太冲、期门、内关、膻中
• 血瘀 → 活血穴：血海、膈俞、三阴交、合谷
• 痰湿 → 化痰穴：丰隆、中脘、阴陵泉、脾俞
• 湿热 → 清热穴：曲池、阴陵泉、大椎、委中

三、配穴原则
1. 主穴 + 配穴
2. 原穴 + 络穴
3. 俞募配穴
4. 表里经配穴`,
        visualDiagram: `
┌─────────────────────────────────────┐
│       辨证配穴对照表                │
├─────────────────────────────────────┤
│                                     │
│  证型          主要穴位             │
│  ────────────────────────           │
│  气虚   →  足三里、气海、关元       │
│  血虚   →  血海、三阴交、膈俞       │
│  阴虚   →  太溪、照海、三阴交       │
│  阳虚   →  命门、关元、肾俞         │
│  气滞   →  太冲、期门、内关         │
│  血瘀   →  血海、膈俞、合谷         │
│  痰湿   →  丰隆、阴陵泉、中脘       │
│  湿热   →  曲池、委中、阴陵泉       │
│                                     │
│  记忆口诀：                         │
│  "气海关元补气虚"                  │
│  "血海三阴养血虚"                  │
│  "太溪照海滋阴虚"                  │
│  "命门关元温阳虚"                  │
│                                     │
└─────────────────────────────────────┘`,
        clinicalCases: [
          '案例：患者诊断为脾气虚（证）→ 配穴：足三里（健脾益气）+ 脾俞（健脾）+ 中脘（和胃）→ 疲劳乏力症状明显改善',
          '案例：患者肝气郁结（证）→ 配穴：太冲（疏肝）+ 期门（疏肝理气）+ 内关（宽胸理气）→ 胸闷胁痛缓解'
        ],
        keyFormulas: [
          '补气四穴：足三里 + 气海 + 关元 + 脾俞',
          '养血四穴：血海 + 三阴交 + 膈俞 + 肝俞',
          '理气三穴：太冲 + 内关 + 膻中'
        ]
      }
    ]
  }
}

async function enhanceKnowledgePoints() {
  console.log('开始增强知识点内容...')

  for (const [code, data] of Object.entries(enhancedKnowledgePoints)) {
    try {
      const category = await prisma.category.findFirst({
        where: { code }
      })

      if (!category) {
        console.log(`❌ 未找到分类: ${code}`)
        continue
      }

      // 更新知识点
      await prisma.category.update({
        where: { id: category.id },
        data: {
          keyPoints: JSON.stringify(data.keyPoints)
        }
      })

      console.log(`✅ 已增强: ${category.name}`)
      console.log(`   - 添加了详细解释`)
      console.log(`   - 添加了视觉图表`)
      console.log(`   - 添加了临床案例`)
      console.log(`   - 添加了常见错误提示`)
      console.log()
    } catch (error) {
      console.error(`❌ 更新失败 ${code}:`, error)
    }
  }

  console.log('✅ 知识点增强完成！')
}

enhanceKnowledgePoints()
  .catch(console.error)
  .finally(() => prisma.$disconnect())
