import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function optimizeBaganFormulas() {
  try {
    const category = await prisma.category.findFirst({
      where: { code: 'DOMAIN_1_ASSESSMENT' }
    })

    if (!category?.keyPoints) {
      console.log('❌ 未找到分类')
      return
    }

    let keyPoints = JSON.parse(category.keyPoints)
    const baganIndex = keyPoints.findIndex((p: any) => p.title === '八纲辨证')

    if (baganIndex === -1) {
      console.log('❌ 未找到八纲辨证知识点')
      return
    }

    // 更详细的方药列表（按照八纲辨证的逻辑分类）
    const optimizedFormulas = [
      // 表证方药
      `【表寒实证】麻黄汤
组成：麻黄、桂枝、杏仁、甘草
功效：发汗解表、宣肺平喘
主治：外感风寒表实证
症状：恶寒重、发热轻、无汗、头身疼痛、脉浮紧`,

      `【表寒虚证】桂枝汤
组成：桂枝、白芍、生姜、大枣、甘草
功效：调和营卫、解肌发表
主治：外感风寒表虚证
症状：头痛发热、汗出恶风、脉浮缓`,

      `【表热证】银翘散
组成：金银花、连翘、薄荷、淡豆豉、桔梗、牛蒡子、竹叶、芦根、甘草
功效：辛凉解表、清热解毒
主治：温病初起表热证
症状：发热、微恶风寒、头痛、口渴、咽痛`,

      // 里证方药
      `【里实热证】大承气汤
组成：大黄、芒硝、枳实、厚朴
功效：峻下热结、泻热通便
主治：阳明腑实证
症状：大便不通、腹满胀痛拒按、高热、口渴、脉沉实`,

      `【里虚寒证】附子理中丸
组成：附子、人参、白术、干姜、甘草
功效：温中散寒、补虚健脾
主治：脾胃虚寒证
症状：腹痛喜温喜按、呕吐泄泻、四肢不温、脉沉细`,

      // 半表半里方药
      `【半表半里证】小柴胡汤
组成：柴胡、黄芩、人参、半夏、甘草、生姜、大枣
功效：和解少阳、扶正祛邪
主治：少阳病证
症状：寒热往来、胸胁苦满、心烦喜呕、默默不欲饮食`,

      // 清热方药
      `【实热证】白虎汤
组成：石膏、知母、甘草、粳米
功效：清热生津、除烦止渴
主治：气分实热证
症状：壮热、大汗、大渴、脉洪大`,

      `【阴虚证】六味地黄丸
组成：熟地黄、山茱萸、山药、泽泻、丹皮、茯苓
功效：滋阴补肾
主治：肝肾阴虚证
症状：腰膝酸软、头晕耳鸣、盗汗、遗精、消渴`,

      // 温寒方药
      `【真寒假热证】四逆汤
组成：附子、干姜、甘草
功效：回阳救逆、温中散寒
主治：少阴病阳虚证、亡阳证
症状：四肢厥冷、恶寒蜷卧、下利清谷、脉微欲绝`,

      // 补虚方药
      `【气虚证】四君子汤
组成：人参、白术、茯苓、甘草
功效：补气健脾
主治：脾胃气虚证
症状：面色萎黄、神疲乏力、食少便溏、脉虚弱`,

      `【血虚证】四物汤
组成：当归、川芎、白芍、熟地黄
功效：补血调经
主治：血虚证
症状：面色萎黄或苍白、头晕目眩、心悸失眠、月经不调`,

      // 寒热并用方药
      `【寒热错杂证】半夏泻心汤
组成：半夏、黄芩、黄连、人参、甘草、干姜、大枣
功效：寒热平调、消痞散结
主治：寒热错杂之痞证
症状：心下痞满、呕吐、肠鸣下利`,

      // 表里双解
      `【表里同病】大柴胡汤
组成：柴胡、黄芩、白芍、半夏、枳实、大黄、生姜、大枣
功效：和解少阳、内泻热结
主治：少阳阳明合病
症状：往来寒热、心烦喜呕、胸胁苦满、腹满便秘`,

      // 虚实夹杂
      `【虚中夹实】补中益气汤
组成：黄芪、人参、白术、当归、陈皮、升麻、柴胡、甘草
功效：补中益气、升阳举陷
主治：脾虚气陷证
症状：身热有汗、渴喜热饮、少气懒言、脱肛、子宫脱垂`,

      `【实中夹虚】黄龙汤
组成：大黄、芒硝、枳实、厚朴、人参、当归、甘草
功效：攻下热结、益气养血
主治：阳明腑实兼气血虚弱
症状：大便不通、腹胀、身热、口渴、气短神疲`,

      // 八纲辨证总纲公式
      `【八纲总纲】
阴证（里、寒、虚）→ 温补为主
阳证（表、热、实）→ 清泻为主
表证（脉浮、起病急）→ 解表法
里证（脉沉、病位深）→ 治里法
寒证（喜暖、脉迟）→ 温法
热证（喜凉、脉数）→ 清法
虚证（喜按、脉弱）→ 补法
实证（拒按、脉实）→ 泻法`
    ]

    // 更新八纲辨证的方药内容
    keyPoints[baganIndex].keyFormulas = optimizedFormulas

    // 更新数据库
    await prisma.category.update({
      where: { id: category.id },
      data: {
        keyPoints: JSON.stringify(keyPoints)
      }
    })

    console.log('✅ 八纲辨证方药内容已优化！')
    console.log('\n📊 优化详情：')
    console.log(`  • 方药总数：${optimizedFormulas.length} 个`)
    console.log('\n📋 包含方药类别：')
    console.log('  1️⃣  表证方药（3个）：麻黄汤、桂枝汤、银翘散')
    console.log('  2️⃣  里证方药（2个）：大承气汤、附子理中丸')
    console.log('  3️⃣  半表半里（1个）：小柴胡汤')
    console.log('  4️⃣  清热方药（2个）：白虎汤、六味地黄丸')
    console.log('  5️⃣  温寒方药（1个）：四逆汤')
    console.log('  6️⃣  补虚方药（2个）：四君子汤、四物汤')
    console.log('  7️⃣  寒热并用（1个）：半夏泻心汤')
    console.log('  8️⃣  表里双解（1个）：大柴胡汤')
    console.log('  9️⃣  虚实夹杂（2个）：补中益气汤、黄龙汤')
    console.log('  🔟 八纲总纲（1个）：辨证施治总公式')
    console.log('\n💡 每个方药包含：')
    console.log('  ✓ 证型分类')
    console.log('  ✓ 药物组成')
    console.log('  ✓ 功效作用')
    console.log('  ✓ 主治病证')
    console.log('  ✓ 典型症状')

  } catch (error) {
    console.error('优化失败:', error)
  } finally {
    await prisma.$disconnect()
  }
}

optimizeBaganFormulas()
