import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function addWuXingTheory() {
  console.log('添加五行学说知识点...\n')

  const category = await prisma.category.findFirst({
    where: { code: 'DOMAIN_1_ASSESSMENT' }
  })

  if (!category) {
    console.log('❌ 未找到Domain 1分类')
    return
  }

  let keyPoints = []
  if (category.keyPoints) {
    try {
      keyPoints = JSON.parse(category.keyPoints)
    } catch (e) {
      console.log('❌ 解析现有知识点失败')
      return
    }
  }

  // 创建五行学说知识点（插入到阴阳学说之后，第二位）
  const wuXingTheory = {
    title: '五行学说',
    description: '五行学说是中医基础理论之一，用木、火、土、金、水五种物质的属性来归纳自然界各种事物和现象，并用五行之间的生克制化关系来解释事物之间的相互联系和运动变化规律。五行学说在中医学中主要用于阐释人体脏腑组织之间的相互关系，以及人体与外界环境的统一。',
    examples: [
      '木：肝、胆、筋、目、怒、青色、酸味、风邪',
      '火：心、小肠、脉、舌、喜、红色、苦味、热邪',
      '土：脾、胃、肉、口、思、黄色、甘味、湿邪',
      '金：肺、大肠、皮毛、鼻、悲、白色、辛味、燥邪',
      '水：肾、膀胱、骨、耳、恐、黑色、咸味、寒邪'
    ],
    detailedExplanation: `五行学说的核心内容：

一、五行的基本属性
• 木：曲直、生发、条达、升发
• 火：炎上、温热、向上
• 土：稼穑、生化、承载、受纳
• 金：从革、清肃、收敛
• 水：润下、寒凉、滋润、下行

二、五行归类（根据NCCAOM教材）

【木】
脏腑：肝、胆
五官：目（风轮、黑睛）
组织：筋
液：泪
情志：怒
气：气逆
五谷：麦
五畜：羊、鸡

【火】
脏腑：心、小肠（阳中之阳）
部位：上焦、胸
五官：舌（血轮、白角）
组织：脉
液：汗
情志：喜
气：气缓
五谷：焦
五畜：豆、禽、乌

【土】
脏腑：脾、胃（阳中之至阴）
五官：口（肉轮、目胞）
组织：肌肉
液：涎
情志：思
气：气结
五谷：香、稻
五畜：牛、人

【金】
脏腑：肺、大肠（阳中之阴）
部位：下焦
五官：鼻（气轮、白睛）
组织：皮毛
液：涕
情志：悲（忧）
气：气消
五谷：睡、麻
五畜：狗、哺

【水】
脏腑：肾、膀胱（阴中之阴）
部位：前阴、腰、下焦
五官：耳（水轮、瞳仁）
组织：骨
液：唾
情志：恐
气：腮
五谷：穗、贝

三、五行的相互关系

1. 相生关系（母子关系）
   木生火 → 肝（木）藏血以济心（火）
   火生土 → 心（火）阳温煦脾（土）
   土生金 → 脾（土）化生气血养肺（金）
   金生水 → 肺（金）清肃下行助肾（水）
   水生木 → 肾（水）藏精以滋肝（木）

2. 相克关系（制约关系）
   木克土 → 肝（木）疏泄调节脾（土）
   土克水 → 脾（土）运化水湿制肾（水）
   水克火 → 肾（水）阴液制约心（火）
   火克金 → 心（火）阳气制约肺（金）
   金克木 → 肺（金）清肃制约肝（木）

3. 相乘相侮（异常变化）
   相乘：过度克制（太过或不及）
   - 木旺乘土：肝气犯胃、肝脾不和
   - 土虚木乘：脾虚肝旺

   相侮：反向克制（反克）
   - 木侮金：肝火犯肺
   - 水侮土：水湿困脾`,
    visualDiagram: `
┌─────────────────────────────────────────────────┐
│              五行生克关系图                     │
├─────────────────────────────────────────────────┤
│                                                 │
│                    火（心）                     │
│                   ↗  ↓  ↖                      │
│                  生   克  生                    │
│                 ↗     ↓    ↖                   │
│              木（肝）  →  土（脾）              │
│               ↑  ↖         ↗  ↓                │
│               生   克     克   生                │
│               ↑     ↖   ↗     ↓                │
│              水（肾） ← 金（肺）                │
│                   ↖  ↑  ↗                      │
│                    生  克 生                    │
│                                                 │
│  ──→ 相生（促进）                              │
│  ···→ 相克（制约）                              │
│                                                 │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│            五行与脏腑对应表                     │
├─────────────────────────────────────────────────┤
│                                                 │
│  五行  脏腑      组织  五官  情志  五液  五色   │
│  ──────────────────────────────────────────────│
│  木    肝胆      筋    目    怒    泪    青     │
│  火    心小肠    脉    舌    喜    汗    红     │
│  土    脾胃      肉    口    思    涎    黄     │
│  金    肺大肠    皮毛  鼻    悲    涕    白     │
│  水    肾膀胱    骨    耳    恐    唾    黑     │
│                                                 │
└─────────────────────────────────────────────────┘`,
    clinicalCases: [
      '案例1：肝气犯胃（木克土太过）\n患者：胁痛、胃痛、嗳气、善太息\n病机：肝气郁结，横逆犯胃（木乘土）\n治法：疏肝和胃\n方药：柴胡疏肝散\n说明：体现木克土的病理变化',

      '案例2：心肾不交（水火不济）\n患者：心烦失眠、腰膝酸软、潮热盗汗\n病机：肾阴不足，不能上济心火（水不制火）\n治法：滋阴降火，交通心肾\n方药：黄连阿胶汤、交泰丸\n说明：水克火的生理失调',

      '案例3：脾肾阳虚（土金两虚）\n患者：久泻不止、畏寒肢冷、完谷不化\n病机：脾土虚弱，不能生金；肾阳不足，不能温土（土金同病）\n治法：温补脾肾\n方药：四神丸\n说明：母病及子（土生金的病理）',

      '案例4：肺肾气虚（金水两虚）\n患者：咳喘日久、气短乏力、腰膝酸软\n病机：肺气虚弱，不能生水；肾气不足，不能纳气（母子俱虚）\n治法：补肺益肾，纳气平喘\n方药：金匮肾气丸、补肺汤\n说明：金生水的生理和病理',

      '案例5：肝火犯肺（木火刑金）\n患者：咳嗽痰中带血、胁痛、口苦\n病机：肝火过旺，上逆犯肺（木火侮金）\n治法：清肝泻火，清肺止血\n方药：黛蛤散、泻白散\n说明：相侮关系（木火侮金）'
    ],
    keyFormulas: [
      '【相生关系】"虚则补其母，实则泻其子"',
      '【母子关系】"子病犯母、母病及子"',
      '【制化关系】"亢则害，承乃制，制则生化"',
      '【生克关系】"有生无制则亢，有制无生则弱"',
      '【五行归类】见教材图表（木火土金水与脏腑、五官、组织、情志、五液的对应）'
    ],
    commonMistakes: [
      '❌ 误区1：只记住五行对应关系，不理解生克制化规律',
      '✅ 正确：掌握相生、相克、相乘、相侮的病理变化',
      '',
      '❌ 误区2：机械套用五行关系，不结合临床实际',
      '✅ 正确：五行只是理论框架，需结合辨证论治',
      '',
      '❌ 误区3：混淆相生和相克的治疗原则',
      '✅ 正确："虚则补其母"是相生关系；"实则泻其子"是相克关系',
      '',
      '❌ 误区4：不理解相乘和相侮的区别',
      '✅ 正确：相乘是顺克太过（如木旺乘土）；相侮是反克（如木侮金）',
      '',
      '💡 考试重点：',
      '1. 五行与脏腑的对应关系（必考）',
      '2. 相生相克在脏腑间的具体体现',
      '3. 临床常见的五行病变（如肝气犯胃、心肾不交）',
      '4. "虚则补其母，实则泻其子"的应用'
    ],
    mindMapData: {
      title: '五行学说',
      subtitle: '自然规律在医学中的应用',
      branches: [
        {
          icon: '🌳',
          title: '木（肝胆）',
          items: [
            { title: '特性：曲直、生发', description: '主升发、疏泄' },
            { title: '脏腑：肝、胆', description: '藏血、疏泄' },
            { title: '组织器官：筋、目', description: '肝主筋、开窍于目' },
            { title: '情志：怒', description: '肝气过旺则易怒' },
            { title: '五液：泪', description: '肝开窍于目，在液为泪' }
          ]
        },
        {
          icon: '🔥',
          title: '火（心小肠）',
          items: [
            { title: '特性：炎上、温热', description: '主温煦、向上' },
            { title: '脏腑：心、小肠', description: '主血脉、神明' },
            { title: '组织器官：脉、舌', description: '心主血脉、开窍于舌' },
            { title: '情志：喜', description: '喜则气缓' },
            { title: '五液：汗', description: '汗为心之液' }
          ]
        },
        {
          icon: '⛰️',
          title: '土（脾胃）',
          items: [
            { title: '特性：稼穑、生化', description: '主运化、生化' },
            { title: '脏腑：脾、胃', description: '后天之本' },
            { title: '组织器官：肉、口', description: '脾主肌肉、开窍于口' },
            { title: '情志：思', description: '思则气结' },
            { title: '五液：涎', description: '脾之液为涎' }
          ]
        },
        {
          icon: '⚪',
          title: '金（肺大肠）',
          items: [
            { title: '特性：从革、清肃', description: '主肃降、收敛' },
            { title: '脏腑：肺、大肠', description: '主气、司呼吸' },
            { title: '组织器官：皮毛、鼻', description: '肺主皮毛、开窍于鼻' },
            { title: '情志：悲（忧）', description: '悲则气消' },
            { title: '五液：涕', description: '肺之液为涕' }
          ]
        },
        {
          icon: '💧',
          title: '水（肾膀胱）',
          items: [
            { title: '特性：润下、寒凉', description: '主藏精、滋润' },
            { title: '脏腑：肾、膀胱', description: '先天之本' },
            { title: '组织器官：骨、耳', description: '肾主骨、开窍于耳' },
            { title: '情志：恐', description: '恐则气下' },
            { title: '五液：唾', description: '肾之液为唾' }
          ]
        },
        {
          icon: '🔄',
          title: '相生关系',
          items: [
            { title: '木生火', description: '肝藏血以济心' },
            { title: '火生土', description: '心阳温煦脾土' },
            { title: '土生金', description: '脾化生气血养肺' },
            { title: '金生水', description: '肺气肃降助肾' },
            { title: '水生木', description: '肾精滋养肝木' }
          ]
        },
        {
          icon: '⚔️',
          title: '相克关系',
          items: [
            { title: '木克土', description: '肝疏泄调节脾' },
            { title: '土克水', description: '脾运化水湿' },
            { title: '水克火', description: '肾阴制约心火' },
            { title: '火克金', description: '心阳制约肺金' },
            { title: '金克木', description: '肺清肃制肝木' }
          ]
        }
      ],
      connections: [
        '相生 → 母子关系 → 虚则补其母',
        '相克 → 制约关系 → 实则泻其子',
        '相乘 → 顺克太过 → 如木旺乘土',
        '相侮 → 反向克制 → 如木火刑金'
      ]
    }
  }

  // 插入到第二位（阴阳学说之后）
  keyPoints.splice(1, 0, wuXingTheory)

  // 更新数据库
  await prisma.category.update({
    where: { id: category.id },
    data: {
      keyPoints: JSON.stringify(keyPoints)
    }
  })

  console.log('✅ 成功添加五行学说知识点到 Domain 1: 評估病人')
  console.log(`   - 位置：第二个知识点（阴阳学说之后）`)
  console.log(`   - 包含：详细解释、思维导图、可视化图表、临床案例、关键公式、常见错误`)
  console.log(`   - 现在该分类共有 ${keyPoints.length} 个知识点`)
}

addWuXingTheory()
  .catch(console.error)
  .finally(() => prisma.$disconnect())
